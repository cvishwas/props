public interface RoleRepository extends JpaRepository<Role, String> {

    @Query(value = """
        SELECT 
            r.role_key            AS roleId,
            r.role_name           AS roleName,
            r.role_desc           AS roleDescription,
            r.status              AS status,
            r.last_updated_userid AS lastUpdatedUser,
            r.last_updated_userid AS lastUpdatedUserId,
            0                     AS isExternal,
            1                     AS isEditable,
            LISTAGG(DISTINCT res.resource_name, ',') 
                WITHIN GROUP (ORDER BY res.resource_name) AS roleApplicationsRaw,
            COUNT(DISTINCT ur.user_key)                 AS userCount,
            r.lastupdatedtimestamp                      AS lastUpdatedTimestamp
        FROM role r
        LEFT JOIN user_role ur 
            ON ur.role_key = r.role_key
        LEFT JOIN role_resource_permission rrp 
            ON rrp.role_key = r.role_key
        LEFT JOIN resource_permissions rp 
            ON rp.resource_permission_key = rrp.resource_permission_key
        LEFT JOIN resources res 
            ON res.resource_id = rp.resource_key
        GROUP BY r.role_key, r.role_name, r.role_desc, r.status,
                 r.last_updated_userid, r.lastupdatedtimestamp
        """, nativeQuery = true)
    List<RoleDashboardDTO> findAllRoleDashboards();
}
