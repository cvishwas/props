import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.criteria.CriteriaBuilder;
import jakarta.persistence.criteria.CriteriaQuery;
import jakarta.persistence.criteria.Join;
import jakarta.persistence.criteria.Root;
import jakarta.persistence.criteria.In;
import jakarta.persistence.TypedQuery;
import jakarta.persistence.criteria.Expression;

import java.util.List;
import java.util.stream.Collectors;

@Repository
public class ResourcePermissionQueryRepository {

    @PersistenceContext
    private EntityManager em;

    /**
     * Retrieve permission names for a list of resource_permission_keys.
     * Each key maps to exactly one permission name; missing keys are ignored.
     */
    public List<String> findPermissionNamesByResourcePermissionKeys(List<Long> keys) {
        if (keys == null || keys.isEmpty()) {
            return List.of();
        }

        CriteriaBuilder cb = em.getCriteriaBuilder();

        // Result type: String (permissionName)
        CriteriaQuery<String> cq = cb.createQuery(String.class);

        // Root entity: ResourcePermission
        Root<ResourcePermission> rp = cq.from(ResourcePermission.class);

        // Join to Permission to access the permissionName
        Join<ResourcePermission, Permission> perm = rp.join("permission");

        // Select the permission name
        cq.select(perm.get("permissionName"));

        // Where: rp.resourcePermissionKey IN (:keys)
        Expression<Long> keyPath = rp.get("resourcePermissionKey");
        In<Long> inClause = cb.in(keyPath);
        for (Long k : keys) {
            inClause.value(k);
        }
        cq.where(inClause);

        TypedQuery<String> query = em.createQuery(cq);
        return query.getResultList();
    }
}